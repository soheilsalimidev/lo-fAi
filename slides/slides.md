---
theme: penguin
class: text-center
highlighter: prism
lineNumbers: false
info: "Train a small language model for generating lo-fi music"
drawings:
  persist: false
transition: slide-left
title: "آموزش یک مدل زبانی كوچک برای ساخت موسیقی lo-fi"
mdc: true
defaults:
  layout: "new-def"
layout: intro
htmlAttrs:
  dir: "rtl"
  lang: "fa"
---

# آموزش یک مدل زبانی كوچک برای ساخت موسیقی lo-fi

_سهیل سلیمی - دکتر زجاجی_

<!-- _[see live at soheilsalimidev.github.io/potential-octo-memory](https://soheilsalimidev.github.io/potential-octo-memory/)_ -->
---
layout: "default"
---
<Toc />

---
layout: "new-def"
---
#  ادبیات موضوع
## RWKV: Reinventing RNNs for the Transformer Era
مدل  RWKV یک مدل پیشرفته است که کارایی شبکه‌های عصبی برگشت‌پذیر را با قدرت توجه به خود ترکیب می‌کند و امکان انجام سریع و مؤثر وظایف دنباله به دنباله را فراهم می‌سازد. 

---
layout: "default"
---
### What is RWKV ?

---
layout: "new-def"
---
## MIDI
MIDI یک فرمت مبتنی بر متن است که موسیقی را به صورت الکترونیکی نمایش می‌دهد. این فرمت شامل اطلاعات نوت‌ها مانند ارتفاع صدا، مدت زمان و تمپو است. هیچ داده صوتی ندارد و فقط دستورالعمل‌هایی برای سازها ارائه می‌دهد. سبک و آسان برای ویرایش است. ورودی کلیدی برای مدل ما جهت تولید موسیقی لو-فای است.

<!-- Represents music as notes and events • No audio data, only instructions • Lightweight and easy to edit • Crucial input for our model • Wide range of musical styles -->

---
layout: "new-def"
---
# بیان مسله
## مشکل من
جستجوی موسیقی پس‌زمینه مناسب برای ویدیوهایم همیشه یک مانع بزرگ بود. از صرف ساعت‌ها وقت برای پیدا کردن موسیقی‌های رایگان که یا خیلی طولانی بودند یا خیلی گران، خسته شده بودم. این مشکل به شدت بهره‌وری من را کاهش می‌داد و می‌دانستم که باید راه‌حلی پیدا کنم. جستجو برای یک روش بهتر، ایده‌ای را در ذهنم جرقه زد و تصمیم گرفتم چالش ایجاد یک ابزار تولید موسیقی را بپذیرم.

---
layout: "default"
---
## بیان مسله
مشکل در کمبود آهنگ‌های موسیقی آماده موجود است که نیازهای خاص طول و هزینه را برآورده کنند. راه‌حل‌های فعلی، مانند وب‌سایت‌های موسیقی بدون حق امتیاز، اغلب در ارائه گزینه‌های مناسب ناکام می‌مانند. این مسئله را می‌توان به چالش‌های کلیدی زیر تقسیم کرد:

1. دسترسی محدود به آهنگ‌های موسیقی
2. طول‌های نامنظم آهنگ‌ها
3. هزینه‌های بالای مرتبط با مجوز موسیقی
4. ناتوانی در سفارشی‌سازی آهنگ‌ها برای برآورده کردن نیازهای خاص
5. دشواری در یافتن آهنگ‌هایی که با لحن و سبک مورد نظر مطابقت داشته باشند

---
layout: "default"
---
## هدف های این پروژه
هدف این پروژه ایجاد ابزاری است که آهنگ‌های موسیقی lo-fi با طول نامحدود تولید کند و به کاربران امکان دهد موسیقی را به دلخواه خود سفارشی و ویرایش کنند. هدف اصلی ارائه یک راه‌حل موسیقی پس‌زمینه با کیفیت بالا برای کاربردهای مختلف مانند تولید محتوای ویدئویی، پادکست‌ها، بازی‌ها و موسیقی آرامش‌بخش است.

این پروژه قصد دارد به این اهداف دست یابد:

- تولید آهنگ‌های موسیقی که می‌توانند به هر طول خاصی گسترش یا کاهش یابند
- اجازه دادن به کاربران برای ویرایش و تغییر موسیقی به منظور تطبیق با لحن، سبک و حالت مورد نظرشان
- ارائه تجربه صوتی آرامش‌بخش و آرام برای گوش دادن شخصی

---
layout: "default"
---
# ضرورت انجام مساله
1. **گزینه‌های خلاقانه محدود**: ابزارهای موجود تولید موسیقی اغلب به آهنگ‌ها یا قالب‌های از پیش موجود متکی هستند که توانایی ایجاد موسیقی منحصر به فرد و سفارشی را محدود می‌کند.
2. **زمان‌بر و پرهزینه**: راه‌حل‌های فعلی اغلب نیاز به جستجوی دستی، مجوزدهی و ویرایش دارند که می‌تواند زمان‌بر و پرهزینه باشد.
3. **راه‌حل‌های ناکافی**: ابزارهای موجود تولید موسیقی اغلب در ارائه گزینه‌های مناسب ناکام هستند که منجر به ناامیدی و اتلاف وقت می‌شود.

---
---
# پروژه های پیشن
## jacbz/Lofi
<div class="text-center mt-2 italic bold">
ML-supported lo-fi music generator Based on VAE
</div>

---
layout: "default"
---
## مشکلات jacbz/Lofi


1. **مدیریت ناکافی وابستگی‌های ترتیبی**: طراحی VEA عمدتاً بر پردازش تصویر متمرکز است و این امر آن را برای وظایف ترتیبی مانند تولید موسیقی کمتر مؤثر می‌کند.
2. **عدم وجود مکانیزم توجه**: مکانیزم توجه VEA ساختار حافظه صریحی ارائه نمی‌دهد که برای ذخیره و بازیابی اطلاعات در وظایف ترتیبی حیاتی است.
3. **معماری غیرقابل انعطاف**: معماری VEA به راحتی قابل تطبیق با وظایف مختلف نیست و این امر تنظیم دقیق آن برای تولید موسیقی را دشوار می‌کند.
4. **عدم کنترل صریح بر خروجی**: خروجی VEA توسط latent space تعیین می‌شود که کنترل دنباله خروجی را چالش‌برانگیز می‌کند.


---
---
# روش پیشنهادی
ما ویژگی‌های صوتی را از نت‌های MIDI با استفاده از یک ابزار تبدیل MIDI به صوت استخراج کردیم. ما یک نمایش توکنیزه شده از ویژگی‌های صوتی با استفاده از یک واژگان از مقادیر گسسته ایجاد کردیم. ما دو مدل RWKV جداگانه، یکی برای پیانو و یکی برای درام، بر روی داده‌های توکنیزه شده آموزش دادیم. مدل پیانو بر روی یک مجموعه داده از 216,284 فایل MIDI پیانو و مدل درام بر روی یک مجموعه داده از 45,537 فایل MIDI درام آموزش داده شد. مدل‌ها استفاده کردیم. ما مدل‌ها را با استفاده از معیارهای موسیقی مانند هماهنگی ریتم و انسجام ملودی ارزیابی کردیم. مدل‌ها توانستند موسیقی با کیفیت بالا و لو-فای تولید کنند که به نت‌های ورودی MIDI بسیار نزدیک بود.

---
---
<div class="flex max-h-full">
<img src="./Untitled.webp" class="max-h-full object-contain scale-125"/>
</div>


---
---
#  مزیت های این روش
1. **حفظ ساختار زمانی**: RWKV به دلیل استفاده از مکانیزم‌های بازگشتی، قادر است ساختار زمانی و توالی‌های طولانی را بهتر حفظ کند. این ویژگی برای موزیک ﻟﻮ-ﻓﺎﻱ که اغلب دارای الگوهای تکراری و ریتمیک است، بسیار مهم است.
2. **کیفیت بازسازی بهتر**: RWKV به دلیل استفاده از مکانیزم توجه، می‌تواند جزئیات بیشتری از داده‌های ورودی را حفظ کند و بازسازی دقیق‌تری ارائه دهد.
3. **انعطاف‌پذیری بیشتر**: این معماری به دلیل استفاده از مکانیزم‌های توجه (Attention mechanism)، می‌تواند به طور دینامیک به بخش‌های مختلف داده توجه کند و این امر باعث می‌شود که در تولید موزیک‌های پیچیده‌تر و متنوع‌تر عملکرد بهتری داشته باشد.

---
---
# پیاده سازی

- **جمع آوری داده**
- **تبدیل داده ها به متن**
- **آموزش مدل ها**
- **ارزیابی عملکرد مدل ها**
- **نحویه ساخت موسیقی نهایی**

---
---
# جمع آوری داده
# مدل پیانو
|                | IrishMMD Dataset |
|----------------|------------------|
| کل فایل ها    | 216,284          |
| فایل های آموزش   | 214,208 (99%)    |
| فایل اعتبارسنجی  | 2,076 (1%)       |

---
---
## مدل دارم
| بخش        | تعداد کل توالی‌ها | مدت زمان (ساعت) |
|------------|-------------------|-----------------|
| آموزشی     | 35,217            | 341.4           |
| اعتبارسنجی | 5,031             | 52.2            |
| کل         | 45,537            | 444.5           |

---
---
# تبدیل MIDI به متن
<div class="flex max-h-full">
<img src="./Untitled 1.png" class="max-h-full object-contain scale-125"/>
</div>

---
---

# آموزش مدل ها
ما از معماری RWKV-6.0 با 20 لایه و Embedding برابر با 512 استفاده کردیم. طول زمینه مدل 512 است. نرخ یادگیری اولیه و نهایی به ترتیب 6e-4 و 6e-5 است و از تابع آنتروپی متقاطع برای محاسبه خطا استفاده می‌شود. پارامتر head_size_a برابر با 64 انتخاب شده تا مدل بتواند به تعداد بیشتری از عناصر ورودی توجه کند. از کتابخانه DeepSpeed نیز استفاده شده که شامل بهینه‌ساز Adam و زمان‌بند نرخ یادگیری کاهش گرم‌شونده است. همچنین، دقت مختلط bfloat16 یا float16 برای بهبود سرعت آموزش فعال شده است.

---
---
# بررسی یادگیری مدل
<div class="flex max-h-full max-w-full gap-2">
<img src="./loss-dr.png" class="max-h-full  max-w-1/2 object-fit"/>
<img src="./loss-pi.png" class="max-h-full max-w-1/2 object-fit"/>
</div>

---
---
# ارزیابی عملکرد مدل

- **ثبات ریتم**: اندازه‌گیری میزان سازگاری ریتم تولید شده موسیقی با ریتم مورد انتظار یک قطعه ساخته شده توسط انسان، با در نظر گرفتن عواملی مانند تمپو، امضای زمانی و الگوهای ریتمیک.

- **معیار شباهت ملودیک**: ارزیابی شباهت بین ملودی تولید شده و یک ملودی مرجع، معمولاً با استفاده از معیارهایی مانند فاصله اقلیدسی، شباهت کسینوسی یا ضریب همبستگی برای اندازه‌گیری میزان شباهت ملودیک.

- **ثبات تونال**: اشاره به میزان پایبندی یک قطعه موسیقی به یک مرکز تونال یا کلید خاص، با یک مرکز تونال پایدار که به طور مداوم در طول موسیقی استفاده می‌شود و هرگونه انحراف از آن نسبتاً جزئی و گذرا است.

- **معیار انسجام هارمونیک**: اندازه‌گیری میزان سازگاری و انسجام هارمونی‌ها و پیشرفت‌های آکورد در یک قطعه موسیقی با کلید یا مرکز تونال زیرین، با در نظر گرفتن عواملی مانند عملکرد آکورد، هدایت صدا و حل هارمونیک.

---
---
#  ارزیابی عملکرد مدل پیانو

| متد                            | مقدار |
|--------------------------------|-------|
| هماهنگی ریتم                   | 0.34  |
| هماهنگی هارمونیک (ملایمت)      | 0.87  |
| هماهنگی هارمونیک (نا‌هم‌خوانی) | 0.13  |
| تغییرات کلید                   | 0.2   |

---
---
# ساخت موسیقی نهایی

<div class="flex max-h-full">
<img src="./Untitled 2.png" class="max-h-full object-contain scale-125"/>
</div>

---
---
# خط لوله متن به Lo-fi

<div class="flex max-h-full">
<img src="./Untitled4.webp" class="max-h-full object-contain scale-125"/>
</div>

---
---
# ارزیابی خط لوله متن به Lo-fi

| سوال                   | پاسخ                                                                                                                            |
|------------------------|---------------------------------------------------------------------------------------------------------------------------------|
| وضوح صدای تولید شده    | 20\% (یک نفر) (خیلی بلند بودن یک ساز و خیلی آرام بودن ساز دیگر)آن را ضعیف ارزیابی کردند و به ناهمخوانی درجه صدا ها اشاره کردند. |
| کیفیت موسیقی تولید شده | 40\% (دو نفر) احساس کردند که صدا عمق و احساس کافی ندارد و آن را تخت توصیف کردند.                                                |
| تطابق با ورودی‌ها      | همه نظر دهندگان به عدم تطابق بین انتظارات و خروجی اشاره کردند.                                                                  |

---
---
<div style="direction: ltr;" class="mt-2">
<ul class="list-inside ">
  <li>[1] Goled, Shraddha (May 7, 2021). "Self-Supervised Learning Vs Semi-Supervised Learning: How They Differ". Analytics India Magazine</li>
  <li>[2] O. Initiative, Open container initiatives. 2020. </li>
  <li>[3] D. Gourley and B. Totty, HTTP: the definitive guide. “ O’Reilly Media, Inc.,” 2002.</li>
    <li>[4] X. Wang, H. Zhao, and J. Zhu, “GRPC: A communication cooperation mechanism in distributed systems,” ACM SIGOPS Operating Systems Review, vol. 27, no. 3, pp. 75–86, 1993.</li>
</ul>
</div>

---
layout: center
---
<div style="height: 10vh" class="flex flex-col justify-center items-center">
<span class="text-7xl font-bold bg-gradient-to-r from-orange-700 via-blue-500 to-green-400 text-transparent bg-clip-text bg-300% animate-gradient p-0 m-0 h-42">
 Thank You
</span>

<p style="height: 10vh" class="text-2xl font-bold bg-gradient-to-r from-orange-700 via-blue-500 to-green-400 text-transparent bg-clip-text bg-300% animate-gradient p-0 m-0">
 Hope you have good day
</p>
</div>



<style>
.animate-gradient {
  background-size: 300%;
  -webkit-animation: animatedgradient 6s ease infinite alternate;
  -moz-animation: animatedgradient 6s ease infinite alternate;
  animation: animatedgradient 6s ease infinite alternate;
}

@keyframes animatedgradient {
  0% {
    background-position: 0% 50%;
  }
  50% {
    background-position: 100% 50%;
  }
  100% {
    background-position: 0% 50%;
  }
}
</style>
